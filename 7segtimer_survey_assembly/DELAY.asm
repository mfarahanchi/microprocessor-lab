.include"m1280def.inc"

.org 0x0000
	RJMP START

.org OC1Aaddr
	JMP INERRUPT2

.org OC0Aaddr
	JMP INERRUPT

START:
	LDI R16, HIGH (RAMEND)
	OUT SPH, R16 

	LDI R16, LOW (RAMEND)
	OUT SPL, R16

	LDI R16,0XF0
	OUT DDRF,R16

	LDI R16,0XFF
	STS DDRK, R16

	LDI R16,0X02
	OUT TCCR0A,R16

	LDI R16,0X05
	OUT TCCR0B,R16

	LDI R16,0X22
	OUT OCR0A,R16

	LDI R16,0X02
	STS TIMSK0,R16

	LDI R16,0X0D
	STS TCCR1B, R16

	LDI R16,0X2A
	STS OCR1AH,R16

	LDI R16,0X30
	STS OCR1AL,R16

	LDI R16,0X02
	STS TIMSK1,R16

	LDI R18,0b00010000
	LDI R21,0X00
	LDI R22,0X00
	LDI R23,0X00
	LDI R24,0X00
	SEI

INERRUPT:
	LSL R18
	CPI R18,0
	BREQ RESET

RESUME:
	OUT PORTF,R18
	CPI R18,0B10000000
	BREQ L1
	CPI R18,0B01000000
	BREQ L2
	CPI R18,0B00100000
	BREQ L3
	CPI R18,0B00010000
	BREQ L4
	RETI

L1:
	MOV R29,R21
	CALL ROUT
	STS PORTK,R29
	RETI

L2:
	MOV R29,R22
	CALL ROUT
	STS PORTK,R29
	RETI

L3:
	MOV R29,R23
	CALL ROUT
	ORI R29,4
	STS PORTK,R29
	RETI

L4:
	MOV R29,R24
	CALL ROUT
	STS PORTK,R29
	RETI

RESET:
	LDI R18,0b00010000
	RJMP RESUME

INERRUPT2:
	INC R21
	CPI R21,10
	BRNE RET1
	INC R22
	LDI R21,0X00
	CPI R22,6
	BRNE RET1
	INC R23
	LDI R22,0X00
	CPI R23,10
	BRNE RET1
	INC R24
	LDI R23,0X00
	CPI R24,6
	BRNE RET1
	LDI R24,0X00

RET1 :
	RETI

rout:
	LDI ZL, LOW(table << 1)
	LDI ZH, HIGH(table << 1)
	ADD ZL, R29
	LPM R29, Z
	RET

table:
	.DB 0xeb, 0x88, 0xb3, 0xba, 0xd8, 0x7a, 0x7b, 0xa8, 0xfb, 0xfa
